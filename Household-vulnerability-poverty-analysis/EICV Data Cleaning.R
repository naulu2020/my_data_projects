# DATA CLEANING OF RWANDA HOUSEHOLD EXPENDITURE SURVEY 23-24.

# Installing packages to use
install.packages('survey')

# Loading libraries to use
library('knitr')
library('tidyverse')
library('skimr')
library('recipes')
library('readr')
library ('haven')
library('survey')

# Setting global working dorectory for my files

setwd("C:\\UWURUKUNDO Nadine\\DATA ANALYTICS COURSES\\RWANDA HOUSEHOLD EXPENDITURE SURVEY 23-24 ANALYSIS")
getwd()

# Loading stata file into R
data <- read_dta("CS_EICV7_poverty_file.dta")
view(data) # 15054 households sampled

#Missing number checking 
any(is.na(data)) # Yes there is the presence of missing values in the dataset
colSums(is.na(data)) # Nearly all the columns do not have missing and the variable with na won't be used in this analysis.

#Loading person dataset
data_person <- read_dta("CS_S0_S1_S2_S3_S4_S6A_S6B_S6C_Person.dta")
view(data_person)
names(data_person) # Checking the names of variables in the dataset
table(data_person$s1q2) # Checking those who are head of household

# Calculating household size 
data_person <- data_person %>%
  group_by(hhid) %>%
  mutate(hhsize2 = n()) %>%
  ungroup()

summary(data_person$hhsize2) # The summary statistics shows that the household composition ranges from 1 to 16 members

# Keeping household head dataset as I am more interested in household information.
hh_head <- data_person %>%
  filter(s1q2 == 1)

# Keeping only variables needed for the Vulnerability analysis from person level dataset
head_dataset <- hh_head %>%
  select(
    hhid,
    hhsize2,   # household size
    s1q1,      # sex of head
    s1q3y,     # age of head
    s1q4       # marital status of head
  )
# Checking for variables labels
attributes(head_dataset$s1q4)

# Assigning short labels to marital status 
head_dataset <- head_dataset %>%
  mutate(
    marital_short = case_when(
      s1q4 %in% c(1, 2) ~ "Married (mono)",
      s1q4 == 3         ~ "Married (poly)",
      s1q4 == 4         ~ "Divorced",
      s1q4 == 5         ~ "Separated",
      s1q4 == 6         ~ "Single",
      s1q4 == 7         ~ "Widowed"
    )
  )
# Assigning factors to variable sex
head_dataset <- head_dataset %>%
  mutate(
    sex = as_factor(s1q1)
  )

# Creation of age group for head of HH
head_dataset <- head_dataset %>%
  mutate(
    age_group = case_when(
      s1q3y < 18                ~ "Child-headed (<18)", # 2 Households are headed by minors.
      s1q3y >= 18 & s1q3y <= 24 ~ "Youth-headed (18–24)",
      s1q3y >= 25 & s1q3y <= 49 ~ "Prime age (25–49)",
      s1q3y >= 50 & s1q3y <= 64 ~ "Older working-age (50–64)",
      s1q3y >= 65               ~ "Elderly-headed (65+)",
      TRUE                      ~ NA_character_
    )
  )

# Merge head of household dataset from person level dataset with the master poverty file

hh_dataset <- data %>%                  # poverty dataset 
  left_join(head_dataset, by = "hhid")


# weight calculation
design_hh <- svydesign(
  ids = ~clust,
  weights = ~weight,
  data = hh_dataset
)

# Adding labels to the province variable
attributes(hh_dataset$province)
hh_dataset<-hh_dataset %>%
  mutate(Province= case_when(
    province==1 ~"Kigali City ",
    province==2 ~"Southern Province ",
    province==3 ~"Western Province ",
    province==4 ~"Northern Province ",
    province==5 ~"Eastern Province "
  ))

# Recording district to have categories
hh_dataset<-hh_dataset %>%
  mutate(District= case_when(
    district==11 ~"Nyarugenge",
    district==12 ~"Gasabo",
    district==13 ~"Kicukiro",
    district==21 ~"Nyanza",
    district==22 ~"Gisagara",
    district==23 ~"Nyaruguru",
    district==24 ~"Huye",
    district==25 ~"Nyamagabe",
    district==26 ~"Ruhango",
    district==27 ~"Muhanga",
    district==28 ~"Kamonyi",
    district==31 ~"Karongi",
    district==32 ~"Rutsiro",
    district==33 ~"Rubavu",
    district==34 ~"Nyabihu",
    district==35 ~"Ngororero",
    district==36 ~"Rusizi",
    district==37 ~"Nyamasheke",
    district==41 ~"Rulindo",
    district==42 ~"Gakenke",
    district==43 ~"Musanze",
    district==44 ~"Burera",
    district==45 ~"Gicumbi",
    district==51 ~"Rwamagana",
    district==52 ~"Nyagatare",
    district==53 ~"Gatsibo",
    district==54 ~"Kayonza",
    district==55 ~"Kirehe",
    district==56 ~"Ngoma",
    district==57 ~"Bugesera")
    )
# Per capita food consumption computation
hh_dataset<-hh_dataset %>%
  mutate (per_capita_food=round(food/member,3))

# food share in total expenditures
hh_dataset <- hh_dataset %>%
  mutate(
    food_share_approx = round((food / cons1) * 100, 3)
  )
#Rename the old variable
hh_dataset <- hh_dataset %>%
  rename(food_share = food_share_approx)

#Assigning categories to food share to analyse HH market access

hh_dataset <- hh_dataset %>%
  mutate(food_share_cat=case_when( 
    food_share<50                    ~ "Low foodexp (<50%)",
    food_share>=50 &  food_share<65  ~ "Medium foodexp (50%-65%)",
    food_share>=65 &  food_share<75 ~ "High foodexp (65%-75%)",
    food_share>=75 &  food_share<100 ~ "Very foodexp (>75%)",
    TRUE                             ~"Outliers")
  )

# Assigning labels to various variables
hh_dataset<-hh_dataset %>%
   mutate(
     region = as_factor(ur)
   ) 
  
hh_dataset<-hh_dataset %>%
  mutate(
    Poverty_cat = as_factor(poverty)
  )     
    
hh_dataset<-hh_dataset %>%
  mutate(
    quintile_cat = as_factor(quintile)
  )   
# Creating binary poverty category 
hh_dataset <- hh_dataset %>%
  mutate(
    poor_binary = case_when(
    Poverty_cat %in% c("Severaly Poor", "Moderately poor") ~"Poor", 
                            TRUE ~ "Non poor")
)

hh_dataset <- hh_dataset %>%
  mutate(poor_bin_num = ifelse(poor_binary == "Poor", 1, 0))

# Save the final dataset to use for analysis
saveRDS(hh_dataset,'hh_dataset_clean.rds')




